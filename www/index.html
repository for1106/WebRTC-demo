<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WebRTC</title>
	<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
	<div class="row">
		<div class="col-sm-12 well">
			<div class="form-group">
				<label class="control-label">Channel</label>
				<div class="input-group">
					<input type="text" class="form-control" id="channel_input">
					<span class="input-group-btn">
						<button class="btn btn-primary" id="broadcast_button">Broadcast</button>
					</span>
					<span class="input-group-btn">
						<button class="btn btn-primary" id="watch_button">Watch</button>
					</span>
					<span class="input-group-btn">
						<button class="btn btn-primary" id="list_button">List</button>
					</span>
				</div>
			</div>
		</div>
	</div>
</div>

<video id="video" autoplay></video>

<div class="modal fade" id="dialog" tabindex="-1" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 class="modal-title">

				</h4>
			</div>
			<div class="modal-body">

			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<script src="js/jquery-3.0.0.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="js/server.js"></script>
<script src="js/client.js"></script>
<script src="js/adapter-1.4.0.js"></script>

<script src="/socket.io/socket.io.js"></script>

<script>
	var video = $('#video'),
		channel_input = $('#channel_input'),
		broadcast_button = $('#broadcast_button'),
		watch_button = $('#watch_button'),
		list_button = $('#list_button'),
		dialog = $('#dialog');

	broadcast_button.on('click', join_broadcast);
	watch_button.on('click', join_watch);
	list_button.on('click', list_call);

	var socket = io();
	socket.on('message',message);
	socket.on('list',list_back);

	socket.on('notify_broadcast',notify_broadcast);
	socket.on('leave_watch',leave_watch);
	socket.on('candidate',candidate);
	socket.on('offer',offer);
	socket.on('answer',answer);

	/////////////////////////////////////////////////////////

	function list_call(){
		socket.emit('list',{
			channel: channel_input.val()
		});
	}

	function list_back(data){
		if(data.flag){
			dialog_show('Broadcast列表',data.list);

			dialog.find('.modal-body p').on('click',function(){
				channel_input.val($(this).text());
				dialog.modal('hide');
			});
		}else{
			dialog_show('Watch列表',data.list);
		}
	}

	function log(){
		var result = ['log'];
		for(var i=0;i<arguments.length;i++){
			result.push(arguments[i]);
		}
		socket.emit.apply(socket,result);
	}

	function message(data){
		if(data.type && data.type == 'alert'){
			dialog_show('警示',data.msg);
		}else{
			console.log.apply(console,data);
		}
	}

	function dialog_show(title,body){
		dialog
		.find('.modal-title').html(title).end()
		.find('.modal-body').html(function(){
			if(!$.isArray(body)){
				body = [body];
			}

			var result = [];
			$.each(body,function(){
				result.push('<p>'+this+'</p>');
			});
			return result.join('');
		}).end()
		.modal('show');
	}
</script>
</body>
</html>